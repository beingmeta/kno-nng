(use-module 'nng)

(define (get-repsock url)
  (let* ((s (nng/repsock))
	 (l (nng/listen s url)))
    (cons s l)))

(define (get-reqsock url)
  (let* ((s (nng/reqsock))
	 (l (nng/dial s url)))
    (cons s l)))

(define stopped #f)

(define (server-loop url)
  (let* ((socket (nng/repsock))
	 (listener (nng/listen socket url)))
    (while (not stopped)
      (let* ((packet (nng/recv socket))
	     (expr (read-xtype packet)))
	(logwarn |ReadPacket| packet)
	(logwarn |Read| expr)
	(if (eq? expr 'quit)
	    (set! stopped #t)
	    (onerror (let* ((value (eval expr))
			    (encoded (emit-xtype value)))
		       (logwarn |Result| value)
		       (nng/send socket encoded)
		       (logwarn |WrotePacket| encoded))
		(lambda (x)
		  (logwarn |NNGError| x)
		  (nng/send socket (emit-xtype 'error)))))))))

(define main server-loop)
